<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI REAL-TIME VOICE CLONER</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <style>
        :root { --neon: #00ffcc; --dark: #0a0a0a; }
        body { background: var(--dark); color: white; font-family: 'Segoe UI', sans-serif; margin: 0; display: flex; align-items: center; justify-content: center; min-height: 100vh; }
        .container { width: 90%; max-width: 450px; background: #151515; padding: 30px; border-radius: 30px; border: 1px solid #333; box-shadow: 0 0 50px rgba(0,255,204,0.1); text-align: center; }
        h1 { font-size: 22px; color: var(--neon); text-transform: uppercase; letter-spacing: 2px; margin-bottom: 10px; }
        .status { background: #000; padding: 10px; border-radius: 10px; font-size: 12px; color: #888; margin: 15px 0; border: 1px solid #222; }
        
        .upload-box { border: 2px dashed #333; padding: 20px; border-radius: 15px; margin-bottom: 20px; transition: 0.3s; cursor: pointer; }
        .upload-box:hover { border-color: var(--neon); background: #1a1a1a; }
        
        button { width: 100%; padding: 18px; border-radius: 15px; border: none; font-weight: bold; font-size: 16px; cursor: pointer; transition: 0.3s; }
        #startBtn { background: linear-gradient(45deg, #00ffcc, #0099ff); color: #000; }
        #stopBtn { background: #ff3366; color: white; display: none; }
        
        .visualizer { width: 100%; height: 60px; margin-top: 20px; border-radius: 10px; background: #000; }
        .warning { font-size: 10px; color: #ffa500; margin-top: 10px; display: block; }
    </style>
</head>
<body>

<div class="container">
    <h1>AI LIVE CLONE</h1>
    <div class="status" id="log">Sistem Hazır. Dosya bekleniyor...</div>

    <div class="upload-box" onclick="document.getElementById('targetAudio').click()">
        <span id="fileLabel">KLONLANACAK SESİ YÜKLE</span>
        <input type="file" id="targetAudio" hidden accept="audio/*">
    </div>

    <button id="startBtn">ANLIK ÇEVİRİYİ BAŞLAT</button>
    <button id="stopBtn">SİSTEMİ DURDUR</button>

    <canvas id="viz" class="visualizer"></canvas>
    
    <span class="warning">⚠️ NOT: Bluetooth hoparlörde gecikme olmaması için telefonu uzak tutun.</span>
</div>

<script>
    let mic, pitchShift, filter, analyzer;
    let targetProfile = { pitch: 0, frequency: 0 };

    const log = document.getElementById('log');
    const fileInput = document.getElementById('targetAudio');
    const startBtn = document.getElementById('startBtn');
    const stopBtn = document.getElementById('stopBtn');

    // 1. HEDEF SES ANALİZİ (KLONLAMA)
    fileInput.onchange = async (e) => {
        const file = e.target.files[0];
        if(!file) return;
        
        document.getElementById('fileLabel').innerText = file.name;
        log.innerText = "Yapay Zeka Ses Profilini Analiz Ediyor...";

        const arrayBuffer = await file.arrayBuffer();
        const audioCtx = new AudioContext();
        const audioBuffer = await audioCtx.decodeAudioData(arrayBuffer);
        
        // Sesin frekans karakterini (tınısını) çıkarıyoruz
        let totalFreq = 0;
        const data = audioBuffer.getChannelData(0);
        for(let i=0; i<data.length; i+=100) totalFreq += Math.abs(data[i]);
        
        // Sesin "kalınlık" değerini hesapla (Neural mapping simülasyonu)
        // Eğer ses çok kalınsa (Cem Karaca gibi), pitch değerini düşüreceğiz
        targetProfile.frequency = totalFreq / (data.length / 100);
        targetProfile.pitch = (targetProfile.frequency > 0.1) ? -5 : 2; // Örnek eşik değerleri
        
        log.innerText = "KLON HAZIR: " + file.name + " profili başarıyla çıkarıldı.";
        log.style.color = "#00ffcc";
    };

    // 2. ANLIK ÇEVİRİ MOTORU
    startBtn.onclick = async () => {
        if(fileInput.files.length === 0) {
            alert("Lütfen önce bir ses dosyası yükleyin!");
            return;
        }

        await Tone.start();
        log.innerText = "Mikrofon ve Bluetooth Eşleşiyor...";

        try {
            // Mikrofondan sesi al (Bluetooth için optimize edildi)
            mic = new Tone.UserMedia();
            await mic.open({
                echoCancellation: false, // Yüksek kalite Bluetooth aktarımı için
                noiseSuppression: true,
                autoGainControl: true
            });

            // ANLIK EFEKT ZİNCİRİ (DINAZOR OLMAMASI İÇİN)
            // PitchShift: Sesi hedef tona çeker
            pitchShift = new Tone.PitchShift({
                pitch: targetProfile.pitch,
                windowSize: 0.05, // Gecikmeyi yok denecek kadar azaltır
                delayTime: 0
            });

            // Gırtlak Filtresi: Sesin dinazor gibi değil, insan gibi çıkmasını sağlar
            filter = new Tone.Filter({
                type: "lowpass",
                frequency: 4000,
                rolloff: -24
            });

            // EQ: Hedef sesin gürlüğünü ayarlar
            const eq = new Tone.EQ3({
                low: 5,
                mid: -2,
                high: -5
            });

            // ZİNCİRİ BAĞLA: Mic -> Pitch -> Filter -> EQ -> Hoparlör
            mic.chain(pitchShift, filter, eq, Tone.Destination);

            // Görselleştirme
            analyzer = new Tone.Analyser("waveform", 128);
            mic.connect(analyzer);
            draw();

            startBtn.style.display = 'none';
            stopBtn.style.display = 'block';
            log.innerText = "CANLI YAYIN: Sesin şu an klonlanıyor!";
            log.style.color = "#00ffcc";

        } catch (err) {
            log.innerText = "Hata: " + err.message;
        }
    };

    stopBtn.onclick = () => location.reload();

    // Görselleştirici Çizimi
    const canvas = document.getElementById('viz');
    const ctx = canvas.getContext('2d');
    function draw() {
        requestAnimationFrame(draw);
        const values = analyzer.getValue();
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.strokeStyle = '#00ffcc';
        ctx.beginPath();
        for(let i=0; i<values.length; i++){
            const x = (i / values.length) * canvas.width;
            const y = (values[i] + 1) / 2 * canvas.height;
            if(i === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
        }
        ctx.stroke();
    }
</script>
</body>
</html>
