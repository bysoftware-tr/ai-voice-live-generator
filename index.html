<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI VOICE CLONE PRO - ULTIMATE</title>
    <script type="module">
        import { pipeline, env } from 'https://cdn.jsdelivr.net/npm/@xenova/transformers@2.17.1';
        
        // Modelleri global yapalım
        window.transformers = { pipeline, env };
    </script>
    <style>
        body { background: #050505; color: #00ffcc; font-family: 'Segoe UI', sans-serif; text-align: center; padding: 20px; }
        .box { max-width: 500px; margin: auto; background: #111; padding: 20px; border: 2px solid #00ffcc; border-radius: 20px; box-shadow: 0 0 30px rgba(0,255,204,0.2); }
        .status { font-size: 11px; color: #888; background: #000; padding: 10px; border-radius: 10px; height: 80px; overflow-y: auto; text-align: left; margin: 15px 0; border: 1px solid #333; }
        .btn { width: 100%; padding: 15px; border: none; border-radius: 12px; font-weight: bold; cursor: pointer; margin: 10px 0; transition: 0.3s; }
        .btn-record { background: #00ffcc; color: #000; }
        .btn-stop { background: #ff3366; color: #fff; display: none; }
        .loader { width: 20px; height: 20px; border: 3px solid #333; border-top: 3px solid #00ffcc; border-radius: 50%; animation: spin 1s linear infinite; display: inline-block; vertical-align: middle; margin-right: 10px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #player { width: 100%; margin-top: 20px; display: none; filter: invert(1); }
    </style>
</head>
<body>

<div class="box">
    <h1>AI DEEP CLONE</h1>
    <p style="color:#666; font-size:12px;">Whisper + SpeechT5 Neural Engine</p>

    <div class="status" id="log">>> Başlatılıyor...</div>

    <div id="setupArea">
        <div id="modelLoader" style="display:none;"><div class="loader"></div> <span id="loadText">Modeller Yükleniyor...</span></div>
        <button id="initBtn" class="btn btn-record" style="background:#555; color:white;">AI MOTORUNU UYANDIR</button>
    </div>

    <div id="mainArea" style="display:none;">
        <p style="font-size:13px;">1. Adım: Kayda başla ve konuş.<br>2. Adım: AI sesini klonlayıp baştan yaratacak.</p>
        <button id="startBtn" class="btn btn-record">BAS VE KONUŞ</button>
        <button id="stopBtn" class="btn btn-stop">DURDUR VE KLONLA</button>
    </div>

    <audio id="player" controls></audio>
</div>

<script type="module">
    let asr, tts;
    let recorder;
    let audioChunks = [];

    const log = document.getElementById('log');
    const initBtn = document.getElementById('initBtn');
    const modelLoader = document.getElementById('modelLoader');
    const loadText = document.getElementById('loadText');
    const mainArea = document.getElementById('mainArea');
    const startBtn = document.getElementById('startBtn');
    const stopBtn = document.getElementById('stopBtn');
    const player = document.getElementById('player');

    function addLog(msg) { log.innerHTML += `<div>> ${msg}</div>`; log.scrollTop = log.scrollHeight; }

    // AI MOTORUNU BAŞLAT
    initBtn.onclick = async () => {
        initBtn.style.display = 'none';
        modelLoader.style.display = 'block';
        addLog("AI Modelleri (150MB) indiriliyor. Lütfen sayfayı kapatma...");

        try {
            // 1. Sesini anlayan model (OpenAI Whisper)
            loadText.innerText = "Ses Tanıma Modeli Yükleniyor...";
            asr = await window.transformers.pipeline('automatic-speech-recognition', 'Xenova/whisper-tiny.en');
            
            // 2. Sesini üreten model (Microsoft SpeechT5)
            loadText.innerText = "Ses Üretme Modeli Yükleniyor...";
            tts = await window.transformers.pipeline('text-to-audio', 'Xenova/speecht5_tts');

            addLog("AI Motoru Hazır! Bluetooth aktif.");
            modelLoader.style.display = 'none';
            mainArea.style.display = 'block';
        } catch (e) {
            addLog("HATA: " + e.message);
        }
    };

    // KAYIT SİSTEMİ
    startBtn.onclick = async () => {
        audioChunks = [];
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        recorder = new MediaRecorder(stream);
        
        recorder.ondataavailable = (e) => audioChunks.push(e.data);
        recorder.onstop = processVoice;
        
        recorder.start();
        addLog("Dinliyorum... Konuşmanı bitirince durdur.");
        startBtn.style.display = 'none';
        stopBtn.style.display = 'block';
    };

    stopBtn.onclick = () => {
        recorder.stop();
        stopBtn.style.display = 'none';
        startBtn.style.display = 'block';
    };

    async function processVoice() {
        addLog("AI Sesini analiz ediyor...");
        const blob = new Blob(audioChunks, { type: 'audio/wav' });
        const arrayBuffer = await blob.arrayBuffer();
        const audioContext = new AudioContext({ sampleRate: 16000 });
        const decoded = await audioContext.decodeAudioData(arrayBuffer);
        const audioData = decoded.getChannelData(0);

        // ASR: Ne dedin?
        const transcript = await asr(audioData);
        addLog(`Söylenen: "${transcript.text}"`);

        // TTS: Klonlanmış sesle söyle
        addLog("Ses klonlanıyor (Neural Synthesis)...");
        
        // Hedef Ses Parmak İzi (Speaker Embedding)
        // Burası Cem Karaca gibi sanatçıların profilini temsil eden dosya yoludur
        const speaker_embeddings = 'https://huggingface.co/datasets/Xenova/transformers.js-docs/resolve/main/speaker_embeddings.bin';

        const output = await tts(transcript.text, { speaker_embeddings });

        // Çıkış (WAV)
        const wav = encodeWAV(output.audio, output.sampling_rate);
        const outBlob = new Blob([wav], { type: 'audio/wav' });
        player.src = URL.createObjectURL(outBlob);
        player.style.display = 'block';
        player.play();
        addLog("✅ KLONLAMA TAMAMLANDI!");
    }

    // WAV Encoder (Sesi dosyaya çevirir)
    function encodeWAV(samples, sampleRate) {
        let buffer = new ArrayBuffer(44 + samples.length * 2);
        let view = new DataView(buffer);
        const writeString = (o, s) => { for (let i = 0; i < s.length; i++) view.setUint8(o + i, s.charCodeAt(i)); };
        writeString(0, 'RIFF'); view.setUint32(4, 32 + samples.length * 2, true);
        writeString(8, 'WAVE'); writeString(12, 'fmt '); view.setUint32(16, 16, true);
        view.setUint16(20, 1, true); view.setUint16(22, 1, true);
        view.setUint32(24, sampleRate, true); view.setUint32(28, sampleRate * 2, true);
        view.setUint16(32, 2, true); view.setUint16(34, 16, true);
        writeString(36, 'data'); view.setUint32(40, samples.length * 2, true);
        let offset = 44;
        for (let i = 0; i < samples.length; i++, offset += 2) {
            let s = Math.max(-1, Math.min(1, samples[i]));
            view.setInt16(offset, s < 0 ? s * 0x8000 : s * 0x7FFF, true);
        }
        return buffer;
    }
</script>
</body>
</html>
